<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Hidden Animals - Scavenger Hunt</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  background:#0a1f14;overflow:hidden;color:white;
  -webkit-user-select:none;user-select:none;touch-action:none;
}

/* MENU STYLES */
.menu-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.92);
  display:flex;justify-content:center;align-items:center;z-index:3000;
  animation:fadeIn .5s ease;
}
.menu-box{
  text-align:center;padding:30px 40px;
  background:rgba(15,45,30,.98);backdrop-filter:blur(25px);
  border:3px solid rgba(129,199,132,.5);border-radius:24px;
  max-width:500px;width:90%;max-height:90vh;overflow-y:auto;
  animation:menuIn .6s ease;
}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes menuIn{from{transform:translateY(30px) scale(.95);opacity:0}to{transform:translateY(0) scale(1);opacity:1}}

.menu-title{
  font-size:42px;color:#81c784;margin-bottom:8px;
  text-shadow:0 2px 8px rgba(0,0,0,.3);
}
.menu-subtitle{
  font-size:16px;color:rgba(255,255,255,.7);margin-bottom:30px;
}
.game-grid{
  display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
  gap:20px;margin-bottom:30px;
}
.game-option{
  background:rgba(20,50,35,.8);border-radius:18px;
  padding:25px 20px;cursor:pointer;transition:all .3s;
  border:2px solid rgba(129,199,132,.3);
  display:flex;flex-direction:column;align-items:center;
}
.game-option:hover{
  transform:translateY(-5px);background:rgba(25,60,40,.9);
  border-color:rgba(129,199,132,.6);box-shadow:0 10px 25px rgba(0,0,0,.3);
}
.game-option.selected{
  background:rgba(30,70,45,.95);border-color:#81c784;
  box-shadow:0 0 0 3px rgba(129,199,132,.2),0 8px 20px rgba(0,0,0,.4);
}
.game-emoji{
  font-size:48px;margin-bottom:15px;filter:drop-shadow(0 4px 8px rgba(0,0,0,.3));
}
.game-name{
  font-size:20px;font-weight:700;color:white;margin-bottom:8px;
}
.game-desc{
  font-size:13px;color:rgba(255,255,255,.6);text-align:center;line-height:1.4;
}
.menu-btn{
  padding:14px 36px;font-size:17px;font-weight:600;
  background:rgba(129,199,132,.2);border:2px solid rgba(129,199,132,.6);
  color:white;border-radius:50px;cursor:pointer;transition:all .3s;
  -webkit-tap-highlight-color:transparent;touch-action:manipulation;
  margin:0 8px;min-width:140px;
}
.menu-btn:hover{
  background:rgba(129,199,132,.35);transform:scale(1.05);
}
.menu-btn:active{transform:scale(.95)}
.menu-btn.primary{background:rgba(76,175,80,.3);border-color:#4CAF50;}
.menu-btn.primary:hover{background:rgba(76,175,80,.4);}
.btn-group{display:flex;justify-content:center;gap:12px;margin-top:10px;}

/* GAME STYLES */
.game-wrap{position:relative;width:100vw;height:100vh;overflow:hidden;display:none;}
.game-wrap.active{display:block;}
canvas{position:absolute;inset:0;z-index:0}
#fgCanvas{z-index:40;pointer-events:none}

.animal-btn{
  position:absolute;z-index:30;
  font-size:clamp(32px,5vw,48px);
  cursor:pointer;line-height:1;
  transition:filter .5s ease,opacity .5s ease,transform .5s ease,font-size .5s ease;
  filter:saturate(.15) brightness(.55) hue-rotate(50deg);
  opacity:.32;
}
.animal-btn:hover{
  opacity:.45;
  filter:saturate(.25) brightness(.65) hue-rotate(30deg);
}
.animal-btn.found{
  font-size:clamp(64px,9vw,100px);
  filter:saturate(1) brightness(1) drop-shadow(0 4px 16px rgba(255,255,255,.6));
  opacity:1;cursor:default;
  animation:animalPop .5s ease;
  z-index:45;
}
@keyframes animalPop{
  0%{transform:scale(.3);opacity:0}
  50%{transform:scale(1.4)}
  100%{transform:scale(1);opacity:1}
}

.info-popup{
  position:absolute;z-index:200;
  background:rgba(10,35,22,.94);backdrop-filter:blur(14px);
  border:2px solid rgba(76,175,80,.6);border-radius:16px;
  padding:12px 18px;min-width:180px;max-width:260px;
  pointer-events:none;
  animation:popupIn .4s ease;
  transform:translateX(-50%);
}
@keyframes popupIn{
  0%{transform:translateX(-50%) scale(.5) translateY(10px);opacity:0}
  100%{transform:translateX(-50%) scale(1) translateY(0);opacity:1}
}
.popup-emoji{font-size:32px;text-align:center;display:block;margin-bottom:4px}
.popup-name{font-size:16px;font-weight:700;color:#81c784;text-align:center;margin-bottom:4px}
.popup-desc{font-size:12px;color:rgba(255,255,255,.7);text-align:center;line-height:1.4}

.hud{
  position:absolute;top:12px;left:50%;transform:translateX(-50%);
  display:flex;gap:10px;z-index:100;pointer-events:none;
}
.hud-box{
  background:rgba(10,30,20,.92);backdrop-filter:blur(12px);
  border:2px solid rgba(76,175,80,.4);border-radius:12px;
  padding:8px 16px;pointer-events:auto;text-align:center;min-width:80px;
}
.hud-label{font-size:10px;color:rgba(255,255,255,.5);margin-bottom:1px;text-transform:uppercase;letter-spacing:.5px}
.hud-value{font-size:clamp(24px,3.5vw,34px);font-weight:700;color:#81c784}

.checklist{
  position:absolute;bottom:12px;left:50%;transform:translateX(-50%);
  background:rgba(10,30,20,.92);backdrop-filter:blur(12px);
  border:2px solid rgba(76,175,80,.4);border-radius:14px;
  padding:8px 14px;z-index:100;
  display:flex;align-items:center;gap:8px;
  max-width:calc(100vw - 240px);
  overflow-x:auto;
}
.checklist::-webkit-scrollbar{height:3px}
.checklist::-webkit-scrollbar-thumb{background:rgba(76,175,80,.3);border-radius:3px}
.cl-item{
  display:flex;align-items:center;gap:5px;
  padding:5px 8px;flex-shrink:0;
  background:rgba(255,255,255,.04);border-radius:8px;
  transition:all .35s ease;
  border:1px solid transparent;
}
.cl-item.found{background:rgba(76,175,80,.2);border-color:rgba(76,175,80,.4)}
.cl-emoji{font-size:20px;filter:grayscale(1) brightness(.5);transition:all .35s;flex-shrink:0}
.cl-item.found .cl-emoji{filter:none;animation:iconPop .5s ease}
@keyframes iconPop{0%,100%{transform:scale(1)}50%{transform:scale(1.35)}}
.cl-name{font-size:11px;color:rgba(255,255,255,.5);white-space:nowrap}
.cl-item.found .cl-name{color:white;font-weight:600}

.btn-corner{
  position:absolute;bottom:12px;z-index:100;
  padding:10px 22px;font-size:14px;font-weight:600;border-radius:50px;
  cursor:pointer;transition:all .3s;backdrop-filter:blur(10px);border:2px solid;
  -webkit-tap-highlight-color:transparent;touch-action:manipulation;
}
.btn-corner:hover{transform:scale(1.05)}
.btn-corner:active{transform:scale(.95)}
.btn-hint{left:14px;background:rgba(255,193,7,.15);border-color:rgba(255,193,7,.4);color:white}
.btn-hint:hover{background:rgba(255,193,7,.25)}
.btn-hint:disabled{opacity:.35;cursor:not-allowed;transform:none}
.btn-menu{right:14px;background:rgba(129,199,132,.12);border-color:rgba(129,199,132,.35);color:white}
.btn-menu:hover{background:rgba(129,199,132,.22)}

.overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.88);
  display:none;justify-content:center;align-items:center;z-index:2000;
}
.overlay.show{display:flex}
.overlay-box{
  text-align:center;padding:36px;
  background:rgba(15,45,30,.96);backdrop-filter:blur(20px);
  border:3px solid rgba(129,199,132,.6);border-radius:22px;
  max-width:440px;animation:boxIn .4s ease;
}
@keyframes boxIn{from{transform:scale(.7);opacity:0}to{transform:scale(1);opacity:1}}
.overlay-title{font-size:38px;color:#81c784;margin-bottom:12px}
.overlay-msg{font-size:20px;margin-bottom:18px}
.overlay-stats{font-size:15px;color:rgba(255,255,255,.7);margin-bottom:22px;line-height:1.8}
.overlay-btn{
  padding:12px 32px;font-size:16px;font-weight:600;
  background:rgba(129,199,132,.2);border:2px solid rgba(129,199,132,.6);
  color:white;border-radius:50px;cursor:pointer;transition:all .3s;margin:5px;
  -webkit-tap-highlight-color:transparent;touch-action:manipulation;
}
.overlay-btn:hover{background:rgba(129,199,132,.35);transform:scale(1.05)}
.overlay-btn:active{transform:scale(.95)}

.ripple{
  position:absolute;
  border:3px solid rgba(129,199,132,.7);border-radius:50%;
  pointer-events:none;z-index:60;
  animation:rippleOut .7s ease-out forwards;
}
@keyframes rippleOut{0%{width:0;height:0;opacity:1}100%{width:120px;height:120px;opacity:0}}

.found-burst{
  position:absolute;pointer-events:none;z-index:70;font-size:18px;
  animation:burstOut .8s ease-out forwards;
}
@keyframes burstOut{
  0%{transform:translate(0,0) scale(1);opacity:1}
  100%{transform:translate(var(--bx),var(--by)) scale(.3);opacity:0}
}

.hint-ring{
  position:absolute;pointer-events:none;z-index:55;
  border:3px dashed rgba(255,193,7,.8);border-radius:50%;
  animation:hintPulse 3s ease-out forwards;
}
@keyframes hintPulse{
  0%{opacity:0;transform:translate(-50%,-50%) scale(.5)}
  20%{opacity:1;transform:translate(-50%,-50%) scale(1)}
  80%{opacity:.8;transform:translate(-50%,-50%) scale(1.05)}
  100%{opacity:0;transform:translate(-50%,-50%) scale(1.1)}
}

.touch-ring{
  position:fixed;width:50px;height:50px;
  border:3px solid rgba(129,199,132,.5);border-radius:50%;
  pointer-events:none;z-index:9999;
  transform:translate(-50%,-50%) scale(0);
  animation:ringPop .5s ease forwards;
}
@keyframes ringPop{
  0%{transform:translate(-50%,-50%) scale(0);opacity:1}
  100%{transform:translate(-50%,-50%) scale(2);opacity:0}
}
</style>
</head>
<body>
<div class="menu-overlay" id="menuOverlay">
  <div class="menu-box">
    <div class="menu-title">üåø Hidden Animals</div>
    <div class="menu-subtitle">Choose a scavenger hunt environment</div>
    
    <div class="game-grid">
      <div class="game-option" data-game="bamboo">
        <div class="game-emoji">üéã</div>
        <div class="game-name">Bamboo Forest</div>
        <div class="game-desc">Find animals hidden in a peaceful bamboo grove with swaying stalks</div>
      </div>
      
      <div class="game-option" data-game="coral">
        <div class="game-emoji">üê†</div>
        <div class="game-name">Coral Reef</div>
        <div class="game-desc">Discover marine creatures in a vibrant underwater coral world</div>
      </div>
      
      <div class="game-option" data-game="arctic">
        <div class="game-emoji">‚ùÑÔ∏è</div>
        <div class="game-name">Arctic Tundra</div>
        <div class="game-desc">Search for cold-weather animals in a snowy polar landscape</div>
      </div>
      
      <div class="game-option" data-game="savanna">
        <div class="game-emoji">üåµ</div>
        <div class="game-name">African Savanna</div>
        <div class="game-desc">Spot wildlife in a grassy plain with acacia trees and sunsets</div>
      </div>
    </div>
    
    <div class="btn-group">
      <button class="menu-btn" id="startBtn">Start Game</button>
      <button class="menu-btn primary" id="howToBtn">How to Play</button>
    </div>
  </div>
</div>

<!-- Bamboo Forest Game -->
<div class="game-wrap" id="gameBamboo">
  <canvas id="sceneBamboo"></canvas>
  <canvas id="fgCanvasBamboo"></canvas>
  
  <div class="hud">
    <div class="hud-box">
      <div class="hud-label">Found</div>
      <div class="hud-value" id="scoreValBamboo">0/8</div>
    </div>
    <div class="hud-box">
      <div class="hud-label">Time</div>
      <div class="hud-value" id="timeValBamboo">0:00</div>
    </div>
  </div>
  
  <div class="checklist" id="clListBamboo"></div>
  <button class="btn-corner btn-hint" id="hintBtnBamboo">Hint (3)</button>
  <button class="btn-corner btn-menu" id="menuBtnBamboo">Menu</button>
</div>

<!-- Coral Reef Game -->
<div class="game-wrap" id="gameCoral">
  <canvas id="sceneCoral"></canvas>
  <canvas id="fgCanvasCoral"></canvas>
  
  <div class="hud">
    <div class="hud-box">
      <div class="hud-label">Found</div>
      <div class="hud-value" id="scoreValCoral">0/8</div>
    </div>
    <div class="hud-box">
      <div class="hud-label">Time</div>
      <div class="hud-value" id="timeValCoral">0:00</div>
    </div>
  </div>
  
  <div class="checklist" id="clListCoral"></div>
  <button class="btn-corner btn-hint" id="hintBtnCoral">Hint (3)</button>
  <button class="btn-corner btn-menu" id="menuBtnCoral">Menu</button>
</div>

<!-- Arctic Game -->
<div class="game-wrap" id="gameArctic">
  <canvas id="sceneArctic"></canvas>
  <canvas id="fgCanvasArctic"></canvas>
  
  <div class="hud">
    <div class="hud-box">
      <div class="hud-label">Found</div>
      <div class="hud-value" id="scoreValArctic">0/8</div>
    </div>
    <div class="hud-box">
      <div class="hud-label">Time</div>
      <div class="hud-value" id="timeValArctic">0:00</div>
    </div>
  </div>
  
  <div class="checklist" id="clListArctic"></div>
  <button class="btn-corner btn-hint" id="hintBtnArctic">Hint (3)</button>
  <button class="btn-corner btn-menu" id="menuBtnArctic">Menu</button>
</div>

<!-- Savanna Game -->
<div class="game-wrap" id="gameSavanna">
  <canvas id="sceneSavanna"></canvas>
  <canvas id="fgCanvasSavanna"></canvas>
  
  <div class="hud">
    <div class="hud-box">
      <div class="hud-label">Found</div>
      <div class="hud-value" id="scoreValSavanna">0/8</div>
    </div>
    <div class="hud-box">
      <div class="hud-label">Time</div>
      <div class="hud-value" id="timeValSavanna">0:00</div>
    </div>
  </div>
  
  <div class="checklist" id="clListSavanna"></div>
  <button class="btn-corner btn-hint" id="hintBtnSavanna">Hint (3)</button>
  <button class="btn-corner btn-menu" id="menuBtnSavanna">Menu</button>
</div>

<!-- Win Overlay (Shared) -->
<div class="overlay" id="winOverlay">
  <div class="overlay-box">
    <div class="overlay-title" id="winTitle">Well Done!</div>
    <div class="overlay-msg" id="winMsg">All animals found!</div>
    <div class="overlay-stats" id="winStats"></div>
    <button class="overlay-btn" id="playAgainBtn">Play Again</button>
    <button class="overlay-btn" id="winMenuBtn" style="margin-left:6px">Menu</button>
  </div>
</div>

<script>
// GAME CONFIGURATION
const GAMES = {
  bamboo: {
    id: 'bamboo',
    name: 'Bamboo Forest',
    emoji: 'üéã',
    color: '#81c784',
    animals: [
      { emoji:'üêº', name:'Panda', desc:'Gentle bamboo eaters that spend 12 hours a day feeding' },
      { emoji:'üêí', name:'Gibbon', desc:'Acrobatic primates that swing through trees with long arms' },
      { emoji:'ü¶ã', name:'Butterfly', desc:'Colorful insects that taste with their feet and see ultraviolet light' },
      { emoji:'üê¶', name:'Songbird', desc:'Small birds that fill forests with beautiful melodies' },
      { emoji:'üêøÔ∏è', name:'Chipmunk', desc:'Striped foragers that store food in their cheek pouches' },
      { emoji:'ü¶î', name:'Hedgehog', desc:'Spiny insectivores that curl into a ball when threatened' },
      { emoji:'ü¶ä', name:'Fox', desc:'Cunning hunters with excellent hearing and bushy tails' },
      { emoji:'ü¶â', name:'Owl', desc:'Silent nocturnal hunters with 270-degree head rotation' }
    ],
    bgColor: '#0a1f14',
    fgColor: '#81c784'
  },
  coral: {
    id: 'coral',
    name: 'Coral Reef',
    emoji: 'üê†',
    color: '#4fc3f7',
    animals: [
      { emoji:'üê†', name:'Clownfish', desc:'Bright orange fish that live symbiotically with sea anemones' },
      { emoji:'üê¢', name:'Sea Turtle', desc:'Ancient mariners that can hold their breath for 5 hours' },
      { emoji:'ü¶à', name:'Reef Shark', desc:'Sleek predators that help maintain reef ecosystem balance' },
      { emoji:'üêô', name:'Octopus', desc:'Intelligent cephalopods that can change color instantly' },
      { emoji:'ü¶Ä', name:'Crab', desc:'Hard-shelled crustaceans that walk sideways' },
      { emoji:'üê¨', name:'Dolphin', desc:'Playful marine mammals that use echolocation to navigate' },
      { emoji:'ü¶ê', name:'Shrimp', desc:'Small crustaceans that clean parasites from larger fish' },
      { emoji:'ü™∏', name:'Sea Star', desc:'Radially symmetric creatures that regenerate lost arms' }
    ],
    bgColor: '#0a1f2e',
    fgColor: '#4fc3f7'
  },
  arctic: {
    id: 'arctic',
    name: 'Arctic Tundra',
    emoji: '‚ùÑÔ∏è',
    color: '#bbdefb',
    animals: [
      { emoji:'üêª‚Äç‚ùÑÔ∏è', name:'Polar Bear', desc:'Largest land carnivores with black skin under white fur' },
      { emoji:'ü¶ä', name:'Arctic Fox', desc:'Small foxes with seasonal camouflage - white in winter' },
      { emoji:'üêã', name:'Beluga', desc:'White whales known as "canaries of the sea" for their vocalizations' },
      { emoji:'ü¶≠', name:'Seal', desc:'Semiaquatic mammals with thick blubber for insulation' },
      { emoji:'üêß', name:'Penguin', desc:'Flightless birds that toboggan on their bellies' },
      { emoji:'ü¶â', name:'Snowy Owl', desc:'White owls that hunt both day and night in the Arctic' },
      { emoji:'üê∫', name:'Arctic Wolf', desc:'White-coated wolves that hunt in packs across the tundra' },
      { emoji:'ü¶å', name:'Caribou', desc:'Migratory deer with large hooves adapted for snow' }
    ],
    bgColor: '#0a1f2e',
    fgColor: '#bbdefb'
  },
  savanna: {
    id: 'savanna',
    name: 'African Savanna',
    emoji: 'üåµ',
    color: '#ffb74d',
    animals: [
      { emoji:'ü¶Å', name:'Lion', desc:'Social big cats where females do most of the hunting' },
      { emoji:'üêò', name:'Elephant', desc:'Largest land animals with trunks containing 40,000 muscles' },
      { emoji:'ü¶í', name:'Giraffe', desc:'Tallest mammals with 20-inch long tongues' },
      { emoji:'ü¶ì', name:'Zebra', desc:'Striped equines with unique patterns like fingerprints' },
      { emoji:'ü¶è', name:'Rhino', desc:'Massive herbivores with horns made of keratin' },
      { emoji:'üêÜ', name:'Leopard', desc:'Solitary cats that drag prey into trees to protect it' },
      { emoji:'ü¶õ', name:'Hippo', desc:'Semi-aquatic mammals that secrete natural sunscreen' },
      { emoji:'üê™', name:'Camel', desc:'Desert-adapted animals that can drink 30 gallons in 13 minutes' }
    ],
    bgColor: '#1f2a0a',
    fgColor: '#ffb74d'
  }
};

// GAME STATE
let currentGame = null;
let gameInstances = {};

// MENU FUNCTIONS
function initMenu() {
  const options = document.querySelectorAll('.game-option');
  options.forEach(option => {
    option.addEventListener('click', function() {
      options.forEach(o => o.classList.remove('selected'));
      this.classList.add('selected');
      currentGame = this.dataset.game;
    });
  });
  
  document.getElementById('startBtn').addEventListener('click', function() {
    if (!currentGame) {
      currentGame = 'bamboo';
      document.querySelector(`[data-game="${currentGame}"]`).classList.add('selected');
    }
    startGame(currentGame);
  });
  
  document.getElementById('howToBtn').addEventListener('click', function() {
    alert('HOW TO PLAY:\n\n1. Click or tap to explore the environment\n2. Find hidden animals by clicking on them\n3. Use hints if you get stuck (3 per game)\n4. Find all 8 animals to win!\n\nEach environment has different animals and visual themes.');
  });
  
  // Auto-select first game
  document.querySelector('.game-option').classList.add('selected');
  currentGame = 'bamboo';
}

function startGame(gameId) {
  document.getElementById('menuOverlay').style.display = 'none';
  
  // Hide all games, show selected
  document.querySelectorAll('.game-wrap').forEach(wrap => {
    wrap.classList.remove('active');
  });
  
  const gameWrap = document.getElementById(`game${gameId.charAt(0).toUpperCase() + gameId.slice(1)}`);
  gameWrap.classList.add('active');
  
  // Initialize or restart game
  if (!gameInstances[gameId]) {
    gameInstances[gameId] = new GameInstance(gameId);
  }
  gameInstances[gameId].init();
}

function returnToMenu() {
  document.querySelectorAll('.game-wrap').forEach(wrap => {
    wrap.classList.remove('active');
  });
  document.getElementById('menuOverlay').style.display = 'flex';
  document.getElementById('winOverlay').classList.remove('show');
}

// GAME INSTANCE CLASS
class GameInstance {
  constructor(gameId) {
    this.gameId = gameId;
    this.config = GAMES[gameId];
    this.W = this.H = 0;
    this.score = 0;
    this.hints = 3;
    this.elapsed = 0;
    this.timer = null;
    this.hiddenAnimals = [];
    this.environment = null;
    this.initialized = false;
  }
  
  init() {
    if (!this.initialized) {
      this.setupCanvas();
      this.setupEventListeners();
      this.initialized = true;
    }
    this.reset();
  }
  
  setupCanvas() {
    this.cvs = document.getElementById(`scene${this.capitalize(this.gameId)}`);
    this.ctx = this.cvs.getContext('2d');
    this.fgCvs = document.getElementById(`fgCanvas${this.capitalize(this.gameId)}`);
    this.fgCtx = this.fgCvs.getContext('2d');
    this.wrap = document.getElementById(`game${this.capitalize(this.gameId)}`);
    
    window.addEventListener('resize', () => this.resize());
    this.resize();
  }
  
  setupEventListeners() {
    const hintBtn = document.getElementById(`hintBtn${this.capitalize(this.gameId)}`);
    const menuBtn = document.getElementById(`menuBtn${this.capitalize(this.gameId)}`);
    
    this.addTouchBtn(`hintBtn${this.capitalize(this.gameId)}`, () => this.useHint());
    this.addTouchBtn(`menuBtn${this.capitalize(this.gameId)}`, returnToMenu);
    
    // Game interaction
    this.wrap.addEventListener('touchstart', (e) => {
      e.preventDefault();
      for (let i = 0; i < e.changedTouches.length; i++) {
        const t = e.changedTouches[i];
        this.handleInteraction(t.clientX, t.clientY);
      }
    }, { passive: false });
    
    this.wrap.addEventListener('click', (e) => {
      this.handleInteraction(e.clientX, e.clientY);
    });
  }
  
  handleInteraction(x, y) {
    this.spawnRipple(x, y);
    this.spawnTouchRing(x, y);
    
    // Check if clicked on animal
    for (let i = 0; i < this.hiddenAnimals.length; i++) {
      const a = this.hiddenAnimals[i];
      if (a.found) continue;
      const rect = a.el.getBoundingClientRect();
      const cx = rect.left + rect.width / 2;
      const cy = rect.top + rect.height / 2;
      
      if (Math.abs(x - cx) < 40 && Math.abs(y - cy) < 40) {
        this.revealAnimal(i);
        return;
      }
    }
  }
  
  resize() {
    this.W = this.cvs.width = this.fgCvs.width = window.innerWidth;
    this.H = this.cvs.height = this.fgCvs.height = window.innerHeight;
    this.buildEnvironment();
    this.drawForeground();
    this.placeAnimals();
  }
  
  buildEnvironment() {
    this.environment = {
      particles: [],
      elements: []
    };
    
    // Create environment-specific particles/elements
    for (let i = 0; i < 25; i++) {
      this.environment.particles.push({
        x: Math.random() * this.W,
        y: Math.random() * this.H,
        r: 1 + Math.random() * 2.5,
        speed: 0.1 + Math.random() * 0.3,
        drift: (Math.random() - 0.5) * 0.5,
        alpha: 0.2 + Math.random() * 0.5,
        phase: Math.random() * Math.PI * 2
      });
    }
  }
  
  drawForeground() {
    this.fgCtx.clearRect(0, 0, this.W, this.H);
    
    // Top gradient
    const topGrad = this.fgCtx.createLinearGradient(0, 0, 0, this.H * 0.08);
    topGrad.addColorStop(0, `rgba(8,28,16,.5)`);
    topGrad.addColorStop(1, 'rgba(8,28,16,0)');
    this.fgCtx.fillStyle = topGrad;
    this.fgCtx.fillRect(0, 0, this.W, this.H * 0.08);
    
    // Bottom gradient
    const btmGrad = this.fgCtx.createLinearGradient(0, this.H - 40, 0, this.H);
    btmGrad.addColorStop(0, 'rgba(8,24,14,0)');
    btmGrad.addColorStop(1, 'rgba(8,24,14,.4)');
    this.fgCtx.fillStyle = btmGrad;
    this.fgCtx.fillRect(0, this.H - 40, this.W, 40);
  }
  
  drawScene(now) {
    const t = now * 0.001;
    
    // Clear canvas with game-specific background
    this.ctx.fillStyle = this.config.bgColor;
    this.ctx.fillRect(0, 0, this.W, this.H);
    
    // Draw game-specific environment
    this.drawGameEnvironment(t);
    
    // Draw particles
    this.environment.particles.forEach(p => {
      p.y -= p.speed;
      p.x += p.drift + Math.sin(t + p.phase) * 0.3;
      if (p.y < -10) { p.y = this.H + 10; p.x = Math.random() * this.W; }
      if (p.x < -10) p.x = this.W + 10;
      if (p.x > this.W + 10) p.x = -10;
      const pa = p.alpha * (0.5 + Math.sin(t * 2 + p.phase) * 0.5);
      this.ctx.beginPath();
      this.ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
      this.ctx.fillStyle = `rgba(200,240,200,${pa})`;
      this.ctx.fill();
    });
    
    // Game-specific overlays
    this.drawGameOverlay(t);
  }
  
  drawGameEnvironment(t) {
    switch(this.gameId) {
      case 'bamboo':
        this.drawBambooForest(t);
        break;
      case 'coral':
        this.drawCoralReef(t);
        break;
      case 'arctic':
        this.drawArctic(t);
        break;
      case 'savanna':
        this.drawSavanna(t);
        break;
    }
  }
  
  drawGameOverlay(t) {
    // Add environmental effects
    switch(this.gameId) {
      case 'bamboo':
        this.drawBambooOverlay(t);
        break;
      case 'coral':
        this.drawCoralOverlay(t);
        break;
      case 'arctic':
        this.drawArcticOverlay(t);
        break;
      case 'savanna':
        this.drawSavannaOverlay(t);
        break;
    }
  }
  
  // ENVIRONMENT DRAWING FUNCTIONS
  drawBambooForest(t) {
    // Draw bamboo stalks
    for (let i = 0; i < 20; i++) {
      const x = (i / 20) * this.W + Math.sin(t * 0.5 + i) * 10;
      const w = 8 + Math.sin(t + i) * 2;
      const h = this.H * (0.6 + Math.sin(t * 0.3 + i) * 0.1);
      const hue = 90 + Math.sin(t * 0.2 + i) * 10;
      
      this.ctx.fillStyle = `hsla(${hue}, 40%, 30%, 0.7)`;
      this.ctx.fillRect(x - w/2, this.H - h, w, h);
      
      // Leaves
      if (i % 3 === 0) {
        this.ctx.fillStyle = `hsla(${hue + 20}, 50%, 40%, 0.6)`;
        this.ctx.save();
        this.ctx.translate(x, this.H - h + 40);
        this.ctx.rotate(Math.sin(t * 0.8 + i) * 0.3);
        this.ctx.fillRect(0, 0, 40, 8);
        this.ctx.restore();
      }
    }
  }
  
  drawCoralReef(t) {
    // Ocean background gradient
    const oceanGrad = this.ctx.createLinearGradient(0, 0, 0, this.H);
    oceanGrad.addColorStop(0, '#0a2f4a');
    oceanGrad.addColorStop(1, '#083456');
    this.ctx.fillStyle = oceanGrad;
    this.ctx.fillRect(0, 0, this.W, this.H);
    
    // Coral formations
    for (let i = 0; i < 15; i++) {
      const x = (i / 15) * this.W;
      const h = 80 + Math.sin(t * 0.4 + i) * 20;
      const hue = 300 + Math.sin(t * 0.3 + i * 2) * 30;
      
      this.ctx.fillStyle = `hsla(${hue}, 70%, 50%, 0.7)`;
      this.ctx.beginPath();
      for (let j = 0; j < 8; j++) {
        const angle = (j / 8) * Math.PI;
        const radius = 15 + Math.sin(t + i + j) * 5;
        const px = x + Math.cos(angle) * radius;
        const py = this.H - 40 - h + Math.sin(angle) * radius;
        if (j === 0) this.ctx.moveTo(px, py);
        else this.ctx.lineTo(px, py);
      }
      this.ctx.closePath();
      this.ctx.fill();
    }
    
    // Bubbles
    for (let i = 0; i < 8; i++) {
      const bx = this.W * 0.2 + Math.sin(t * 0.5 + i) * 100;
      const by = this.H * 0.7 - (t * 20 + i * 50) % (this.H * 0.8);
      const br = 3 + Math.sin(t + i) * 2;
      
      this.ctx.fillStyle = `rgba(100, 200, 255, 0.6)`;
      this.ctx.beginPath();
      this.ctx.arc(bx, by, br, 0, Math.PI * 2);
      this.ctx.fill();
    }
  }
  
  drawArctic(t) {
    // Sky gradient
    const skyGrad = this.ctx.createLinearGradient(0, 0, 0, this.H);
    skyGrad.addColorStop(0, '#a8d8ff');
    skyGrad.addColorStop(0.4, '#c2e4ff');
    skyGrad.addColorStop(1, '#e1f2ff');
    this.ctx.fillStyle = skyGrad;
    this.ctx.fillRect(0, 0, this.W, this.H);
    
    // Snow ground
    this.ctx.fillStyle = '#ffffff';
    this.ctx.fillRect(0, this.H * 0.7, this.W, this.H * 0.3);
    
    // Snowflakes
    for (let i = 0; i < 15; i++) {
      const sx = (t * 10 + i * 50) % this.W;
      const sy = (t * 20 + i * 30) % this.H;
      const sr = 2 + Math.sin(t + i) * 1;
      
      this.ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
      this.ctx.beginPath();
      this.ctx.arc(sx, sy, sr, 0, Math.PI * 2);
      this.ctx.fill();
    }
    
    // Icebergs
    for (let i = 0; i < 5; i++) {
      const ix = (i / 5) * this.W + Math.sin(t * 0.2 + i) * 30;
      const iw = 60 + Math.sin(t + i) * 20;
      const ih = 40 + Math.sin(t * 0.5 + i) * 15;
      
      this.ctx.fillStyle = 'rgba(220, 240, 255, 0.9)';
      this.ctx.beginPath();
      this.ctx.moveTo(ix - iw/2, this.H * 0.7);
      this.ctx.lineTo(ix + iw/2, this.H * 0.7);
      this.ctx.lineTo(ix + iw/4, this.H * 0.7 - ih);
      this.ctx.lineTo(ix - iw/4, this.H * 0.7 - ih);
      this.ctx.closePath();
      this.ctx.fill();
    }
  }
  
  drawSavanna(t) {
    // Sky gradient
    const skyGrad = this.ctx.createLinearGradient(0, 0, 0, this.H * 0.6);
    skyGrad.addColorStop(0, '#ffcc80');
    skyGrad.addColorStop(1, '#ffb74d');
    this.ctx.fillStyle = skyGrad;
    this.ctx.fillRect(0, 0, this.W, this.H * 0.6);
    
    // Ground
    const groundGrad = this.ctx.createLinearGradient(0, this.H * 0.6, 0, this.H);
    groundGrad.addColorStop(0, '#8d6e63');
    groundGrad.addColorStop(1, '#5d4037');
    this.ctx.fillStyle = groundGrad;
    this.ctx.fillRect(0, this.H * 0.6, this.W, this.H * 0.4);
    
    // Grass
    this.ctx.fillStyle = '#7cb342';
    for (let i = 0; i < 40; i++) {
      const gx = (i / 40) * this.W;
      const gh = 15 + Math.sin(t * 0.5 + i) * 5;
      this.ctx.fillRect(gx, this.H * 0.6, 3, -gh);
    }
    
    // Acacia trees
    for (let i = 0; i < 8; i++) {
      const tx = (i / 8) * this.W + 40;
      const tw = 10;
      const th = 80 + Math.sin(t * 0.3 + i) * 10;
      
      // Trunk
      this.ctx.fillStyle = '#8d6e63';
      this.ctx.fillRect(tx - tw/2, this.H * 0.6 - th, tw, th);
      
      // Canopy
      this.ctx.fillStyle = '#558b2f';
      this.ctx.beginPath();
      this.ctx.arc(tx, this.H * 0.6 - th, 25, 0, Math.PI * 2);
      this.ctx.fill();
    }
  }
  
  drawBambooOverlay(t) {
    // Light rays
    for (let i = 0; i < 3; i++) {
      const alpha = 0.03 + Math.sin(t * 0.2 + i) * 0.02;
      this.ctx.fillStyle = `rgba(200, 255, 200, ${alpha})`;
      this.ctx.fillRect(i * this.W/3, 0, 100, this.H);
    }
  }
  
  drawCoralOverlay(t) {
    // Light rays from surface
    for (let i = 0; i < 4; i++) {
      const alpha = 0.05 + Math.sin(t * 0.3 + i) * 0.03;
      this.ctx.fillStyle = `rgba(100, 200, 255, ${alpha})`;
      this.ctx.fillRect(i * this.W/4 + 50, 0, 40, this.H);
    }
  }
  
  drawArcticOverlay(t) {
    // Aurora effect
    for (let i = 0; i < this.W; i += 2) {
      const alpha = 0.1 * Math.sin(i * 0.02 + t * 2) * Math.sin(t * 0.5);
      this.ctx.fillStyle = `rgba(200, 255, 255, ${alpha})`;
      this.ctx.fillRect(i, this.H * 0.2, 2, 20);
    }
  }
  
  drawSavannaOverlay(t) {
    // Heat haze
    for (let i = 0; i < 5; i++) {
      const alpha = 0.05 + Math.sin(t * 0.4 + i) * 0.03;
      this.ctx.fillStyle = `rgba(255, 200, 100, ${alpha})`;
      this.ctx.fillRect(i * this.W/5, this.H * 0.5, 150, 100);
    }
  }
  
  placeAnimals() {
    // Clear existing animals
    this.hiddenAnimals.forEach(a => a.el.remove());
    this.hiddenAnimals = [];
    
    const margin = 90;
    const minDist = 120;
    const midTop = this.H * 0.22;
    const midBot = this.H * 0.72;
    
    this.config.animals.forEach(def => {
      let x, y, tries = 0;
      do {
        x = margin + Math.random() * (this.W - margin * 2);
        y = midTop + Math.random() * (midBot - midTop);
        tries++;
      } while (tries < 400 && this.hiddenAnimals.some(a => 
        Math.hypot(a.x - x, a.y - y) < minDist));
      
      this.hiddenAnimals.push({
        emoji: def.emoji,
        name: def.name,
        desc: def.desc,
        x: x, y: y,
        found: false
      });
    });
    
    // Create DOM elements for animals
    this.hiddenAnimals.forEach(a => {
      const el = document.createElement('div');
      el.className = 'animal-btn';
      el.textContent = a.emoji;
      el.style.left = (a.x - 24) + 'px';
      el.style.top = (a.y - 24) + 'px';
      a.el = el;
      this.wrap.appendChild(el);
    });
    
    // Build checklist
    this.buildChecklist();
  }
  
  buildChecklist() {
    const el = document.getElementById(`clList${this.capitalize(this.gameId)}`);
    el.innerHTML = '';
    this.config.animals.forEach((a, i) => {
      const item = document.createElement('div');
      item.className = 'cl-item';
      item.id = `cl-${this.gameId}-${i}`;
      item.innerHTML = `<span class="cl-emoji">${a.emoji}</span><span class="cl-name">${a.name}</span>`;
      el.appendChild(item);
    });
  }
  
  reset() {
    this.score = 0;
    this.hints = 3;
    this.elapsed = 0;
    
    if (this.timer) clearInterval(this.timer);
    
    // Update UI
    document.getElementById(`scoreVal${this.capitalize(this.gameId)}`).textContent = '0/8';
    document.getElementById(`timeVal${this.capitalize(this.gameId)}`).textContent = '0:00';
    document.getElementById(`hintBtn${this.capitalize(this.gameId)}`).textContent = 'Hint (3)';
    document.getElementById(`hintBtn${this.capitalize(this.gameId)}`).disabled = false;
    
    // Reset animals
    this.hiddenAnimals.forEach(a => {
      a.el.classList.remove('found');
      a.found = false;
      a.el.style.fontSize = 'clamp(32px,5vw,48px)';
      a.el.style.filter = 'saturate(.15) brightness(.55) hue-rotate(50deg)';
      a.el.style.opacity = '.32';
    });
    
    // Reset checklist
    this.config.animals.forEach((a, i) => {
      const item = document.getElementById(`cl-${this.gameId}-${i}`);
      if (item) item.classList.remove('found');
    });
    
    // Start timer
    this.startTimer();
    
    // Start animation loop
    if (this.animationId) cancelAnimationFrame(this.animationId);
    this.animationLoop();
  }
  
  startTimer() {
    this.timer = setInterval(() => {
      this.elapsed++;
      const m = Math.floor(this.elapsed / 60);
      const s = this.elapsed % 60;
      document.getElementById(`timeVal${this.capitalize(this.gameId)}`).textContent = 
        m + ':' + (s < 10 ? '0' : '') + s;
    }, 1000);
  }
  
  animationLoop() {
    const loop = (now) => {
      this.drawScene(now);
      this.animationId = requestAnimationFrame(loop);
    };
    this.animationId = requestAnimationFrame(loop);
  }
  
  revealAnimal(idx) {
    const a = this.hiddenAnimals[idx];
    if (a.found) return;
    a.found = true;
    a.el.classList.add('found');
    this.score++;
    
    document.getElementById(`scoreVal${this.capitalize(this.gameId)}`).textContent = 
      this.score + '/8';
    
    // Update checklist
    const clIdx = this.config.animals.findIndex(g => g.name === a.name);
    if (clIdx >= 0) {
      const item = document.getElementById(`cl-${this.gameId}-${clIdx}`);
      if (item) item.classList.add('found');
    }
    
    this.spawnBurst(a.x, a.y);
    this.showPopup(a);
    this.playChime();
    
    if (this.score === 8) this.endGame();
  }
  
  showPopup(a) {
    const popup = document.createElement('div');
    popup.className = 'info-popup';
    popup.style.left = a.x + 'px';
    popup.style.top = Math.max(60, a.y - 80) + 'px';
    popup.innerHTML = `
      <span class="popup-emoji">${a.emoji}</span>
      <div class="popup-name">${a.name}</div>
      <div class="popup-desc">${a.desc}</div>
    `;
    this.wrap.appendChild(popup);
    setTimeout(() => {
      popup.style.transition = 'opacity .4s';
      popup.style.opacity = '0';
      setTimeout(() => popup.remove(), 400);
    }, 3000);
  }
  
  useHint() {
    if (this.hints <= 0) return;
    const remaining = this.hiddenAnimals.filter(a => !a.found);
    if (!remaining.length) return;
    const target = remaining[Math.floor(Math.random() * remaining.length)];
    
    const ring = document.createElement('div');
    ring.className = 'hint-ring';
    ring.style.left = target.x + 'px';
    ring.style.top = target.y + 'px';
    ring.style.width = '90px';
    ring.style.height = '90px';
    this.wrap.appendChild(ring);
    ring.addEventListener('animationend', () => ring.remove());
    
    this.hints--;
    const btn = document.getElementById(`hintBtn${this.capitalize(this.gameId)}`);
    btn.textContent = this.hints > 0 ? `Hint (${this.hints})` : 'No Hints';
    if (this.hints <= 0) btn.disabled = true;
  }
  
  endGame() {
    clearInterval(this.timer);
    setTimeout(() => {
      const m = Math.floor(this.elapsed / 60);
      const s = this.elapsed % 60;
      document.getElementById('winTitle').textContent = 'Well Done!';
      document.getElementById('winMsg').textContent = `All ${this.config.name} animals found!`;
      document.getElementById('winStats').innerHTML = `
        Environment: ${this.config.name}<br>
        Time: ${m}:${s < 10 ? '0' : ''}${s}<br>
        Hints used: ${3 - this.hints}
      `;
      document.getElementById('winOverlay').classList.add('show');
    }, 600);
  }
  
  // HELPER FUNCTIONS
  capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
  }
  
  addTouchBtn(id, fn) {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('click', (e) => { 
      if (!(e.sourceCapabilities && e.sourceCapabilities.firesTouchEvents)) fn(); 
    });
    el.addEventListener('touchend', (e) => { 
      e.preventDefault(); 
      e.stopPropagation(); 
      fn(); 
    });
  }
  
  spawnRipple(x, y) {
    const r = document.createElement('div');
    r.className = 'ripple';
    r.style.left = x + 'px';
    r.style.top = y + 'px';
    r.style.marginLeft = '-60px';
    r.style.marginTop = '-60px';
    this.wrap.appendChild(r);
    r.addEventListener('animationend', () => r.remove());
  }
  
  spawnBurst(x, y) {
    const bits = ['\u2B50', '\u2728', '\uD83C\uDF1F', '\uD83D\uDCAB', '\uD83C\uDF3F'];
    for (let i = 0; i < 12; i++) {
      const el = document.createElement('div');
      el.className = 'found-burst';
      el.textContent = bits[i % bits.length];
      el.style.left = x + 'px';
      el.style.top = y + 'px';
      const angle = (i / 12) * Math.PI * 2;
      const dist = 50 + Math.random() * 70;
      el.style.setProperty('--bx', (Math.cos(angle) * dist) + 'px');
      el.style.setProperty('--by', (Math.sin(angle) * dist) + 'px');
      this.wrap.appendChild(el);
      el.addEventListener('animationend', function() { this.remove(); });
    }
  }
  
  spawnTouchRing(x, y) {
    const ring = document.createElement('div');
    ring.className = 'touch-ring';
    ring.style.left = x + 'px';
    ring.style.top = y + 'px';
    document.body.appendChild(ring);
    ring.addEventListener('animationend', () => ring.remove());
  }
  
  playChime() {
    try {
      const ac = new (window.AudioContext || window.webkitAudioContext)();
      [523.25, 659.25, 783.99].forEach((freq, i) => {
        const o = ac.createOscillator(), g = ac.createGain();
        o.connect(g); g.connect(ac.destination);
        o.frequency.value = freq; o.type = 'sine';
        const t0 = ac.currentTime + i * .08;
        g.gain.setValueAtTime(.2, t0);
        g.gain.exponentialRampToValueAtTime(.001, t0 + .3);
        o.start(t0); o.stop(t0 + .3);
      });
    } catch (e) {}
  }
}

// INITIALIZE APPLICATION
document.addEventListener('DOMContentLoaded', () => {
  initMenu();
  
  // Win overlay buttons
  document.getElementById('playAgainBtn').addEventListener('click', () => {
    document.getElementById('winOverlay').classList.remove('show');
    if (currentGame && gameInstances[currentGame]) {
      gameInstances[currentGame].reset();
    }
  });
  
  document.getElementById('winMenuBtn').addEventListener('click', () => {
    document.getElementById('winOverlay').classList.remove('show');
    returnToMenu();
  });
});
</script>
</body>
</html>